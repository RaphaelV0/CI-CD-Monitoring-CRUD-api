name: Build and Deploy to Cloud Run

on:
  push:
    tags:
      - 'v*.*.*'

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: ${{ secrets.GCP_REGION }}
  SERVICE_NAME: crud-api
  FLUENT_BIT_SERVICE_NAME: crud-fluent-bit

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. RÃ©cupÃ©ration du code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Extraction de la version depuis le tag
      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      # 3. Connexion Ã  Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4. Build et push de l'image de l'API
      - name: Build and push API image
        run: |
          cd App
          docker build -t ${{ env.DOCKERHUB_USERNAME }}/${{ env.SERVICE_NAME }}:${{ steps.version.outputs.version }} .
          docker build -t ${{ env.DOCKERHUB_USERNAME }}/${{ env.SERVICE_NAME }}:latest .
          docker push ${{ env.DOCKERHUB_USERNAME }}/${{ env.SERVICE_NAME }}:${{ steps.version.outputs.version }}
          docker push ${{ env.DOCKERHUB_USERNAME }}/${{ env.SERVICE_NAME }}:latest

      # 5. Build et push de l'image Fluent Bit
      - name: Build and push Fluent Bit image
        run: |
          docker build -f Dockerfile.fluentbit -t ${{ env.DOCKERHUB_USERNAME }}/${{ env.FLUENT_BIT_SERVICE_NAME }}:${{ steps.version.outputs.version }} .
          docker build -f Dockerfile.fluentbit -t ${{ env.DOCKERHUB_USERNAME }}/${{ env.FLUENT_BIT_SERVICE_NAME }}:latest .
          docker push ${{ env.DOCKERHUB_USERNAME }}/${{ env.FLUENT_BIT_SERVICE_NAME }}:${{ steps.version.outputs.version }}
          docker push ${{ env.DOCKERHUB_USERNAME }}/${{ env.FLUENT_BIT_SERVICE_NAME }}:latest

      # 6. Configuration du SDK Google Cloud
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # 7. ExÃ©cution des migrations de base de donnÃ©es
      - name: Run database migrations
        run: |
          # Build l'image de migration
          docker build -f Dockerfile.migrations -t migration-runner .
          
          # CrÃ©er un fichier temporaire avec les credentials
          echo '${{ secrets.GCP_SA_KEY }}' > /tmp/sa-key.json
          
          # ExÃ©cuter les migrations via Cloud SQL Proxy
          docker run --rm \
            -v /tmp/sa-key.json:/sa-key.json \
            -e GOOGLE_APPLICATION_CREDENTIALS=/sa-key.json \
            -e DB_USER=${{ secrets.DB_USER }} \
            -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
            -e DB_NAME=${{ secrets.DB_NAME }} \
            migration-runner \
            sh -c "cloud_sql_proxy -instances=${{ secrets.DB_INSTANCE_CONNECTION_NAME }}=tcp:3306 & sleep 10 && node migrations.js"
          
          # Nettoyer
          rm -f /tmp/sa-key.json

      # 8. Mise Ã  jour du fichier de configuration Cloud Run
      - name: Update Cloud Run service configuration
        run: |
          # Remplacer les placeholders dans le fichier
          sed -i "s|GCP_REGION|${{ env.GCP_REGION }}|g" cloud-run-service.yaml
          sed -i "s|DB_INSTANCE_CONNECTION_NAME|${{ secrets.DB_INSTANCE_CONNECTION_NAME }}|g" cloud-run-service.yaml
          sed -i "s|DOCKERHUB_USERNAME|${{ env.DOCKERHUB_USERNAME }}|g" cloud-run-service.yaml
          sed -i "s|VERSION|${{ steps.version.outputs.version }}|g" cloud-run-service.yaml
          sed -i "s|DB_USER|${{ secrets.DB_USER }}|g" cloud-run-service.yaml
          sed -i "s|DB_PASSWORD|${{ secrets.DB_PASSWORD }}|g" cloud-run-service.yaml
          sed -i "s|DB_NAME|${{ secrets.DB_NAME }}|g" cloud-run-service.yaml
          sed -i "s|LOKI_HOST|${{ secrets.LOKI_HOST }}|g" cloud-run-service.yaml
          sed -i "s|LOKI_PORT|${{ secrets.LOKI_PORT }}|g" cloud-run-service.yaml
          
          echo "Cloud Run configuration updated:"
          cat cloud-run-service.yaml

      # 9. DÃ©ploiement sur Cloud Run
      - name: Deploy to Cloud Run
        run: |
          gcloud run services replace cloud-run-service.yaml \
            --platform=managed \
            --region=${{ env.GCP_REGION }}
          
          # Autoriser les invocations non authentifiÃ©es
          gcloud run services add-iam-policy-binding ${{ env.SERVICE_NAME }} \
            --region=${{ env.GCP_REGION }} \
            --member="allUsers" \
            --role="roles/run.invoker"
          
          # Obtenir l'URL du service
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)')
          
          echo "Service deployed at: $SERVICE_URL"
          echo "service_url=$SERVICE_URL" >> $GITHUB_OUTPUT

      # 10. VÃ©rification du dÃ©ploiement
      - name: Verify deployment
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)')
          
          echo "Testing API endpoint..."
          sleep 10
          curl -f "$SERVICE_URL/api/users" || echo "API not ready yet, but deployment succeeded"

      # 11. Notification de succÃ¨s
      - name: Deployment summary
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)')
          
          echo "âœ… Deployment successful!"
          echo " Version: ${{ steps.version.outputs.version }}"
          echo " Service URL: $SERVICE_URL"
          echo "ðŸ‘¥ API Users: $SERVICE_URL/api/users"
