name: Build and Deploy to Cloud Run

on:
  push:
    tags:
      - 'v*'

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: ${{ secrets.GCP_REGION }}
  SERVICE_NAME: crud-api
  FLUENT_BIT_SERVICE_NAME: crud-fluent-bit

jobs:
  build-and-deploy:
    name: Build, migrate database, and deploy to Cloud Run
    runs-on: ubuntu-latest
    
    steps:
      # 1. Récupération du code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Extraction de la version depuis le tag
      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version extracted: $VERSION"

      # 3. Connexion à Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      # 4. Build et push de l'image de l'API
      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: ./App
          push: true
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/${{ env.SERVICE_NAME }}:${{ steps.version.outputs.version }}
            ${{ env.DOCKERHUB_USERNAME }}/${{ env.SERVICE_NAME }}:latest

      # 5. Build et push de l'image Fluent Bit
      - name: Build and push Fluent Bit image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.fluentbit
          push: true
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/${{ env.FLUENT_BIT_SERVICE_NAME }}:${{ steps.version.outputs.version }}
            ${{ env.DOCKERHUB_USERNAME }}/${{ env.FLUENT_BIT_SERVICE_NAME }}:latest

      # 6. Configuration du SDK Google Cloud
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # 7. Exécution des migrations de base de données
      - name: Install and start Cloud SQL Proxy
        run: |
          wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64 -O cloud_sql_proxy
          chmod +x cloud_sql_proxy
          ./cloud_sql_proxy -instances=${{ secrets.DB_INSTANCE_CONNECTION_NAME }}=tcp:3306 &
          
          # Attendre que le proxy soit prêt
          echo "Waiting for Cloud SQL Proxy to be ready..."
          for i in {1..30}; do
            if nc -z 127.0.0.1 3306 2>/dev/null; then
              echo "✅ Cloud SQL Proxy is ready!"
              break
            fi
            echo "Attempt $i/30: Proxy not ready yet..."
            sleep 2
          done
          
          # Vérification finale
          if ! nc -z 127.0.0.1 3306 2>/dev/null; then
            echo "❌ Cloud SQL Proxy failed to start"
            exit 1
          fi

      - name: Run database migrations
        run: |
          docker build -f Dockerfile.migrations -t migration-runner . 
          
          docker run --rm --network host \
            -e DB_HOST="127.0.0.1" \
            -e DB_USER="${{ secrets.DB_USER }}" \
            -e DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
            -e DB_NAME="${{ secrets.DB_NAME }}" \
            migration-runner
          
          echo "✅ Migrations completed"

      # 8. Mise à jour du fichier de configuration Cloud Run
      - name: Update Cloud Run service configuration
        run: |
          # Remplacement des Placeholders définis dans cloud-run-service.yaml
          sed -i "s|GCP_REGION|${{ env.GCP_REGION }}|g" cloud-run-service.yaml
          sed -i "s|DB_INSTANCE_CONNECTION_NAME|${{ secrets.DB_INSTANCE_CONNECTION_NAME }}|g" cloud-run-service.yaml
          sed -i "s|DOCKERHUB_USERNAME|${{ env.DOCKERHUB_USERNAME }}|g" cloud-run-service.yaml
          sed -i "s|VERSION|${{ steps.version.outputs.version }}|g" cloud-run-service.yaml
          sed -i "s|DB_USER|${{ secrets.DB_USER }}|g" cloud-run-service.yaml
          sed -i "s|DB_PASSWORD|${{ secrets.DB_PASSWORD }}|g" cloud-run-service.yaml
          sed -i "s|DB_NAME|${{ secrets.DB_NAME }}|g" cloud-run-service.yaml
          sed -i "s|LOKI_HOST|${{ secrets.LOKI_HOST }}|g" cloud-run-service.yaml
          sed -i "s|LOKI_PORT|${{ secrets.LOKI_PORT }}|g" cloud-run-service.yaml
          
          echo "Configuration Cloud Run mise à jour :"
          cat cloud-run-service.yaml

      # 9. Déploiement sur Cloud Run
      - name: Deploy to Cloud Run
        run: |
          # Déploiement du service
          gcloud run services replace cloud-run-service.yaml --region ${{ env.GCP_REGION }}
          # Autorisation publique
          gcloud run services add-iam-policy-binding ${{ env.SERVICE_NAME }} \
            --region=${{ env.GCP_REGION }} \
            --member="allUsers" \
            --role="roles/run.invoker"

      # 10. Vérification du déploiement
      - name: Verify deployment
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)')
          
          echo "Testing API endpoint..."
          sleep 10
          # Le || true permet de ne pas faire échouer le pipeline si le curl échoue (optionnel)
          curl -f "$SERVICE_URL/api/users" || echo "API not ready yet, but deployment succeeded"

      # 11. Notification de succès
      - name: Deployment summary
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)')
          
          echo "✅ Deployment successful!"
          echo " Version: ${{ steps.version.outputs.version }}"
          echo " Service URL: $SERVICE_URL"